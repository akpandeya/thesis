% warn about LaTeX 'sins'
\RequirePackage[l2tabu, orthodox]{nag}

\documentclass[
     a4paper
    ,fontsize=12pt
    ,titlepage=false
    ,fleqn
    ,oneside
]{scrartcl}

%%% latex-report settings
\usepackage{etoolbox}
\providetoggle{lrHideToc}
\providetoggle{lrHideTitle}
\providetoggle{lrSmallHeadings}
\providetoggle{lrHeaderDate}

% Run this code only after the user had the chance to change the toggles
\AtEndPreamble{
    % In case the user did not specify:
    \providecommand{\lrDate}{\today}
    \providecommand{\lrDirectory}{latex-report}

    % Load custom commands
    \input{\lrDirectory/include/commands}

    % Small section headings?
    \iftoggle{lrSmallHeadings}{
        \KOMAoptions{headings=small}
    }{}

    %%% Fonts
    \setsansfont[
        Path           = \lrDirectory/fonts/Lato/,
        Scale          = .95,
        Extension      = .ttf,
        UprightFont    = *-Regular,
        BoldFont       = *-Bold,
        ItalicFont     = *-Italic,
        BoldItalicFont = *-BoldItalic ]{Lato}

    \setmonofont[
        Path           = \lrDirectory/fonts/SourceCodePro/,
        Scale          = .87,
        Extension      = .ttf,
        UprightFont    = *-Regular,
        BoldFont       = *-Black ]{SourceCodePro}

    %%% Header, footer
    \usepackage[automark,headsepline=.6pt]{scrlayer-scrpage}
    \addtokomafont{headsepline}{\color{header}}
    \setkomafont{pagehead}{\color{header}}

    \clearpairofpagestyles
    \iftoggle{lrHeaderDate}{
        \ihead[\lrTitle]{\lrTitle}
        \ohead[\lrAuthor]{\lrAuthor, \lrDate}
    }{
        \ohead[\lrTitle]{\lrTitle}
    }
    \cfoot[\pagemark]{\pagemark}
}

%%% Fonts, encoding
\usepackage[log-declarations=false]{xparse} % load explicitely to quiet warnings
\usepackage[quiet]{fontspec}
\usepackage{lmodern}

%%% Math, symbols, units
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{upgreek}
\usepackage{xspace}
\usepackage{bm}
\usepackage{dsfont}
\usepackage{siunitx}

% Bold vectors
\renewcommand{\vec}[1]{\mathbf{#1}}

% redefine \\ inside the 'align'-environment to add \notag to all equations except the last
\makeatletter
\def\Let@{\def\\{\notag\math@cr}}
\makeatother

%%% Graphics
\usepackage{graphicx}
\usepackage{subfig}
\usepackage[
     font=small
    ,labelfont=bf
]{caption}
\captionsetup*[figure]{name=Fig.}
\graphicspath{{fig/}}

%%% Layout, typesetting, formatting
\usepackage{booktabs}
\usepackage{microtype}
\usepackage[iso]{datetime}

%%% Colors
\usepackage{xcolor}
\definecolor{link}{rgb}{0.,0.4,1}
\definecolor{header}{gray}{0.15}

%%% Remove TOC headings
\makeatletter
\renewcommand\tableofcontents{%
    \@starttoc{toc}%
}
\makeatother

%%% Hyperref
\usepackage[
     pdfusetitle
    ,colorlinks=true
    ,citecolor=link
    ,linkcolor=link
    ,pdfborder={0 0 0}
    ,unicode=true
]{hyperref}

%%% Run this code after \begin{document}
\AtBeginDocument{
    \title{\lrTitle}
    \author{\lrAuthor}
    \date{\lrDate}

    %%% Title section
    \nottoggle{lrHideTitle}{
        \noindent{\LARGE \textsf{\textbf{\lrTitle}}}\\
        \thispagestyle{empty}
    }{}

    %%% TOC
    \nottoggle{lrHideToc}{
        % Disable microtype protrusion for the TOC
        \microtypesetup{protrusion=false}
        \tableofcontents
        \microtypesetup{protrusion=true}
        \vspace{8mm}
    }{}
}
